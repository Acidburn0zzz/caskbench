#!/bin/bash

# This script assumes you've built caskbench in a sub-directory named
# "build-HOST".  It invokes the executable from that build tree, and
# stores the results in a directory named results-HOST-SURFACE-NNN.

iterations=100
size=256
host=$(hostname -s)


cd build-${host}

surfaces=$(src/caskbench -l)

for surface in ${surfaces}; do
    id=0
    out=.
    while [ -d "${out}" ]; do
	id=$(( id + 1 ))
	out=$(printf "../results-${host}-${surface}-%03d" $id)
    done
    outjson="${out}/results.json"
    outtxt="${out}/results.txt"
    rm -f cairo*.png skia*.png
    mkdir ${out}
    cp ../index.html ${out}/
    echo "== ${surface^^} ==" | tee ${outtxt}
    src/caskbench -t ${surface} -i ${iterations} -s ${size} -o ${outjson} | tee -a ${outtxt}
    if [ $? == 0 ]; then
	mv cairo*.png skia*.png ${out}/
    fi
    echo | tee ${outtxt}
done
